name: Claude Code Agent

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'

  # Trigger on @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

  # Trigger on ai-task labeled issues
  issues:
    types: [opened, labeled]

  workflow_dispatch:
    inputs:
      task_override:
        description: 'Override task (skip project board)'
        required: false
        type: string
      issue_number:
        description: 'Specific issue number to work on'
        required: false
        type: string
      dry_run:
        description: 'Dry run (no commits/PRs)'
        required: false
        type: boolean
        default: false

# Only one agent at a time
concurrency:
  group: claude-agent
  cancel-in-progress: false  # Don't cancel running agents

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Handle scheduled runs and manual dispatch
  run-agent:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.17'
          otp-version: '27'

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Cache Elixir deps
        uses: actions/cache@v5
        with:
          path: deps
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: |
          mix deps.get
          npm install -g @anthropic-ai/claude-code

      - name: Fetch tasks from GitHub Issues
        id: tasks
        if: ${{ !inputs.task_override && !inputs.issue_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch issues with 'ai-task' label, prioritize by agent tags
          TASK=$(gh issue list \
            --label "ai-task" \
            --state open \
            --json number,title,body,labels \
            --jq 'sort_by(.number) | .[0] // empty' \
            | head -1)

          if [ -z "$TASK" ]; then
            echo "No ai-task issues found"
            echo "has_task=false" >> $GITHUB_OUTPUT
          else
            echo "task=$TASK" >> $GITHUB_OUTPUT
            echo "has_task=true" >> $GITHUB_OUTPUT
            echo "Found task: $(echo $TASK | jq -r '.title')"
          fi

      - name: Get specific issue
        id: specific_issue
        if: ${{ inputs.issue_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK=$(gh issue view ${{ inputs.issue_number }} --json number,title,body)
          echo "task=$TASK" >> $GITHUB_OUTPUT
          echo "has_task=true" >> $GITHUB_OUTPUT

      - name: Run Claude Agent
        if: steps.tasks.outputs.has_task == 'true' || steps.specific_issue.outputs.has_task == 'true' || inputs.task_override
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
          TASK_OVERRIDE: ${{ inputs.task_override }}
          INPUT_ISSUE_NUM: ${{ inputs.issue_number }}
          SPECIFIC_ISSUE_JSON: ${{ steps.specific_issue.outputs.task }}
          TASKS_JSON: ${{ steps.tasks.outputs.task }}
        run: |
          # Determine task source
          if [ -n "$TASK_OVERRIDE" ]; then
            TASK_BODY="$TASK_OVERRIDE"
            TASK_TITLE="Manual task"
            ISSUE_NUM=""
          elif [ -n "$INPUT_ISSUE_NUM" ]; then
            TASK_BODY=$(echo "$SPECIFIC_ISSUE_JSON" | jq -r '.body // empty')
            TASK_TITLE=$(echo "$SPECIFIC_ISSUE_JSON" | jq -r '.title // empty')
            ISSUE_NUM="$INPUT_ISSUE_NUM"
          else
            TASK_BODY=$(echo "$TASKS_JSON" | jq -r '.body // empty')
            TASK_TITLE=$(echo "$TASKS_JSON" | jq -r '.title // empty')
            ISSUE_NUM=$(echo "$TASKS_JSON" | jq -r '.number // empty')
          fi

          # Configure git for commits
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

          # Create feature branch
          if [ -n "$ISSUE_NUM" ]; then
            BRANCH="feature/issue-${ISSUE_NUM}"
          else
            BRANCH="agent/task-$(date +%Y%m%d-%H%M%S)"
          fi
          git checkout -b "$BRANCH"

          # Write prompt to a temp file to avoid shell escaping issues
          cat > /tmp/claude-prompt.txt << 'PROMPT_EOF'
          Implement this task autonomously:

          Instructions:
          1. Read CLAUDE.md for project conventions
          2. Explore relevant code to understand patterns
          3. Implement the solution
          4. Run tests and format code appropriately
          5. Commit with descriptive message

          Only ask for clarification if requirements are truly ambiguous.
          Work autonomously - the software should build itself.
          PROMPT_EOF

          # Append task details safely
          echo "" >> /tmp/claude-prompt.txt
          echo "Title: ${TASK_TITLE}" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "${TASK_BODY}" >> /tmp/claude-prompt.txt

          # Run Claude Code with full permissions
          claude --print --dangerously-skip-permissions "$(cat /tmp/claude-prompt.txt)"

          # Check for changes - either uncommitted or already committed by Claude
          UNCOMMITTED_CHANGES=false
          COMMITS_AHEAD=0

          if ! git diff --quiet || ! git diff --staged --quiet; then
            UNCOMMITTED_CHANGES=true
          fi

          # Check if there are commits ahead of origin/main (Claude may have already committed)
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          echo "Uncommitted changes: $UNCOMMITTED_CHANGES"
          echo "Commits ahead of origin/main: $COMMITS_AHEAD"

          # Exit early if dry run
          if [ "$DRY_RUN" = "true" ]; then
            echo "Dry run - skipping commit and PR creation"
            git diff --stat
            exit 0
          fi

          # If there are uncommitted changes, commit them
          if [ "$UNCOMMITTED_CHANGES" = "true" ]; then
            git add -A
            git commit -m "feat: ${TASK_TITLE}

          Closes #${ISSUE_NUM}

          Co-Authored-By: Claude Agent <claude-agent@users.noreply.github.com>"
          fi

          # Re-check commits ahead after potential commit
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          # If we have commits to push, create PR
          if [ "$COMMITS_AHEAD" -gt "0" ]; then
            echo "Pushing $COMMITS_AHEAD commit(s) to origin/$BRANCH"
            git push -u origin "$BRANCH"

            # Create PR
            PR_BODY="## Summary
          Automated implementation from Claude Agent.

          ## Task
          ${TASK_TITLE}

          ${TASK}

          ## Closes
          ${ISSUE_NUM:+Closes #$ISSUE_NUM}

          ---
          *This PR was created automatically by Claude Code Agent*"

            gh pr create \
              --title "feat: ${TASK_TITLE}" \
              --body "$PR_BODY" \
              --base main

            # Remove ai-task label since it's now being worked on
            if [ -n "$ISSUE_NUM" ]; then
              gh issue edit "$ISSUE_NUM" --remove-label "ai-task" --add-label "in-progress"
            fi
          else
            echo "No changes to push"
          fi

  # Handle @claude mentions in issues/PRs
  handle-mention:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.17'
          otp-version: '27'

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          mix deps.get
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

          # Remove @claude mention and write to temp file
          echo "$COMMENT_BODY" | sed 's/@claude//g' > /tmp/claude-task.txt

          # Run Claude with the task from file
          RESPONSE=$(claude --print --dangerously-skip-permissions "$(cat /tmp/claude-task.txt)" 2>&1)

          # Write response to file with header
          cat > /tmp/claude-response.txt << 'EOF'
          ## Claude Response

          EOF
          echo "$RESPONSE" >> /tmp/claude-response.txt
          echo "" >> /tmp/claude-response.txt
          echo "---" >> /tmp/claude-response.txt
          echo "*Response from Claude Code Agent*" >> /tmp/claude-response.txt

          # Post response as comment using file
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/claude-response.txt

  # Handle new ai-task labeled issues
  handle-new-task:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'ai-task')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.17'
          otp-version: '27'

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          mix deps.get
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          TASK_TITLE: ${{ github.event.issue.title }}
          TASK_BODY: ${{ github.event.issue.body }}
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

          # Create feature branch
          BRANCH="feature/issue-${ISSUE_NUM}"
          git checkout -b "$BRANCH"

          # Write prompt to a temp file to avoid shell escaping issues
          cat > /tmp/claude-prompt.txt << 'PROMPT_EOF'
          Implement this GitHub issue autonomously:

          Instructions:
          1. Read CLAUDE.md for project conventions
          2. Explore relevant code to understand patterns
          3. Implement the solution
          4. Run tests and format code appropriately
          5. Commit with descriptive message

          Only ask for clarification if requirements are truly ambiguous.
          PROMPT_EOF

          # Append issue details safely
          echo "" >> /tmp/claude-prompt.txt
          echo "Issue #${ISSUE_NUM}: ${TASK_TITLE}" >> /tmp/claude-prompt.txt
          echo "" >> /tmp/claude-prompt.txt
          echo "${TASK_BODY}" >> /tmp/claude-prompt.txt

          # Run Claude with prompt from file
          claude --print --dangerously-skip-permissions "$(cat /tmp/claude-prompt.txt)"

          # Check for changes - either uncommitted or already committed by Claude
          UNCOMMITTED_CHANGES=false
          COMMITS_AHEAD=0

          if ! git diff --quiet || ! git diff --staged --quiet; then
            UNCOMMITTED_CHANGES=true
          fi

          # Check if there are commits ahead of origin/main (Claude may have already committed)
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          echo "Uncommitted changes: $UNCOMMITTED_CHANGES"
          echo "Commits ahead of origin/main: $COMMITS_AHEAD"

          # If there are uncommitted changes, commit them
          if [ "$UNCOMMITTED_CHANGES" = "true" ]; then
            git add -A
            git commit -m "feat: ${TASK_TITLE}

          Closes #${ISSUE_NUM}

          Co-Authored-By: Claude Agent <claude-agent@users.noreply.github.com>"
          fi

          # Re-check commits ahead after potential commit
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          # If we have commits to push, create PR
          if [ "$COMMITS_AHEAD" -gt "0" ]; then
            echo "Pushing $COMMITS_AHEAD commit(s) to origin/$BRANCH"
            git push -u origin "$BRANCH"

            gh pr create \
              --title "feat: ${TASK_TITLE}" \
              --body "Closes #${ISSUE_NUM}

          Automated implementation by Claude Agent." \
              --base main

            gh issue edit "$ISSUE_NUM" --remove-label "ai-task" --add-label "in-progress"
          else
            echo "No changes to push"
          fi
